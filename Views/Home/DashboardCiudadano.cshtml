<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Ciudadano - Monclova</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }

        .logo-container {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #28a745;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            overflow: hidden;
            padding: 5px;
            flex-shrink: 0;
        }

            .logo img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: block;
            }

            .logo i {
                color: #28a745;
                font-size: 1.3rem;
            }

        .header-info {
            flex: 1;
            min-width: 0;
        }

            .header-info h1 {
                font-size: clamp(1rem, 3vw, 1.3rem);
                font-weight: 700;
                color: white;
                margin-bottom: 0.2rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .header-info p {
                font-size: clamp(0.75rem, 2vw, 0.85rem);
                color: rgba(255, 255, 255, 0.9);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #28a745;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            flex-shrink: 0;
        }

            .user-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .user-avatar i {
                color: #28a745;
                font-size: 1.3rem;
            }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .nav-menu {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 10;
        }

        .nav-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-item {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

            .nav-item:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            }

            .nav-item.active {
                background: linear-gradient(135deg, #1e7e34 0%, #28a745 100%);
                box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }

        .home-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .home-card {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            text-align: center;
            text-decoration: none;
            display: block;
        }

            .home-card:hover {
                transform: translateY(-5px);
            }

        .home-card-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .home-card h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .home-card p {
            font-size: 14px;
            opacity: 0.9;
        }

        .form-section {
            margin-bottom: 30px;
        }

            .form-section h2 {
                color: #28a745;
                font-size: 20px;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #28a745;
            }

        .form-group {
            margin-bottom: 20px;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                color: #333;
                font-weight: 500;
            }

                .form-group label .required {
                    color: #dc3545;
                }

            .form-group input,
            .form-group select,
            .form-group textarea {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color 0.2s;
            }

                .form-group input:focus,
                .form-group select:focus,
                .form-group textarea:focus {
                    outline: none;
                    border-color: #28a745;
                }

            .form-group textarea {
                min-height: 100px;
                resize: vertical;
            }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s;
        }

            .btn:hover {
                transform: translateY(-2px);
            }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .gps-button {
            margin-top: 10px;
        }

        .tip-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

            .tip-box strong {
                color: #155724;
            }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #28a745;
        }

        .photo-upload {
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

            .photo-upload:hover {
                background-color: #d4edda;
            }

        .photo-preview {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
        }

            .photo-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px;
            }

        .photo-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
        }

        .submit-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            text-align: right;
        }

        .view-content {
            display: none;
        }

            .view-content.active {
                display: block;
            }

        .report-card {
            background: white;
            border: 1px solid #d4edda;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

            .report-card:hover {
                border-color: #28a745;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15);
            }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .report-folio {
            font-size: 18px;
            font-weight: 700;
            color: #28a745;
        }

        .report-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pendiente {
            background: #fff3cd;
            color: #856404;
        }

        .status-proceso {
            background: #cfe2ff;
            color: #084298;
        }

        .status-completado {
            background: #d1e7dd;
            color: #0f5132;
        }

        .report-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .report-field {
            display: flex;
            flex-direction: column;
        }

        .report-field-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .report-field-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .report-description {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .report-description-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .report-description-text {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-container">
                    <div class="logo">
                        <img src="/imagenes/ServiciosPrimarios.png" alt="Servicios" onerror="this.parentElement.innerHTML='<i class=\'fas fa-tools\'></i>'">
                    </div>
                    <div class="logo">
                        <img src="/imagenes/LOGO.png" alt="Gobierno" onerror="this.parentElement.innerHTML='<i class=\'fas fa-landmark\'></i>'">
                    </div>
                </div>
                <div class="header-info">
                    <h1>Portal Ciudadano - Servicios Municipales</h1>
                    <p>Municipio de Monclova, Coahuila</p>
                </div>
            </div>
            <div class="user-avatar">
                <img src="/images/usuario.jpg" alt="Usuario" onerror="this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>'">
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Navigation Menu -->
        <nav class="nav-menu" id="navMenu">
            <div class="nav-items">
                <a href="#" class="nav-item active" onclick="changeView(event, 'home')">
                    <i class="fas fa-home"></i> Inicio
                </a>
                <a href="#" class="nav-item" onclick="changeView(event, 'create')">
                    <i class="fas fa-plus-circle"></i> Crear Reporte
                </a>
                <a href="#" class="nav-item" onclick="changeView(event, 'reports')">
                    <i class="fas fa-clipboard-list"></i> Mis Reportes
                </a>
                <a href="/Home/UnidadesGPSCiudadanos" class="nav-item">
                    <i class="fas fa-map-marker-alt"></i> Unidades GPS
                </a>
                <a href="/Home/DirectorioCiudadanos" class="nav-item">
                    <i class="fas fa-phone"></i> Directorio
                </a>
                <a href="/Home/EventosCiudadanos" class="nav-item">
                    <i class="fas fa-calendar"></i> Eventos
                </a>
                <a href="/Home/TramitesCiudadanos" class="nav-item">
                    <i class="fas fa-file-alt"></i> Trámites
                </a>
            </div>
        </nav>

        <!-- Home View -->
        <div class="view-content active" id="homeView">
            <div class="content-card">
                <h2 style="color: #28a745; font-size: 28px; margin-bottom: 10px;">Bienvenido al Portal Ciudadano</h2>
                <p style="color: #666; margin-bottom: 30px;">Gestiona tus reportes y accede a servicios municipales</p>

                <div class="home-grid">
                    <a href="#" class="home-card" onclick="changeView(event, 'create')">
                        <div class="home-card-icon">📝</div>
                        <h3>Crear Reporte</h3>
                        <p>Reporta problemas en tu comunidad</p>
                    </a>
                    <a href="#" class="home-card" onclick="changeView(event, 'reports')">
                        <div class="home-card-icon">📋</div>
                        <h3>Mis Reportes</h3>
                        <p>Consulta el estado de tus reportes</p>
                    </a>
                    <a href="/Home/UnidadesGPSCiudadanos" class="home-card">
                        <div class="home-card-icon">🚨</div>
                        <h3>Unidades de Servicio</h3>
                        <p>Ubicación en tiempo real</p>
                    </a>
                    <a href="/Home/DirectorioCiudadanos" class="home-card">
                        <div class="home-card-icon">📞</div>
                        <h3>Directorio</h3>
                        <p>Contactos de presidencia</p>
                    </a>
                    <a href="/Home/EventosCiudadanos" class="home-card">
                        <div class="home-card-icon">📅</div>
                        <h3>Eventos</h3>
                        <p>Próximos eventos municipales</p>
                    </a>
                    <a href="/Home/TramitesCiudadanos" class="home-card">
                        <div class="home-card-icon">📄</div>
                        <h3>Trámites</h3>
                        <p>Realiza trámites municipales</p>
                    </a>
                    <div class="home-card">
                        <div class="home-card-icon">ℹ️</div>
                        <h3>Información</h3>
                        <p>Acerca del sistema</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Report View -->
        <div class="view-content" id="createView">
            <div class="content-card">
                <h2 style="color: #28a745; font-size: 28px; margin-bottom: 20px;">📝 Crear Nuevo Reporte</h2>

                <form id="reportForm">
                    <!-- Información Personal -->
                    <div class="form-section">
                        <h2>👤 Información Personal</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre Completo <span class="required">*</span></label>
                                <input type="text" id="nombre" required placeholder="Ingrese su nombre completo">
                            </div>
                            <div class="form-group">
                                <label>Teléfono <span class="required">*</span></label>
                                <input type="tel" id="telefono" required placeholder="10 dígitos">
                            </div>
                        </div>
                    </div>

                    <!-- Ubicación del Problema -->
                    <div class="form-section">
                        <h2>📍 Ubicación del Problema</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Calle <span class="required">*</span></label>
                                <input type="text" id="calle" required placeholder="Nombre de la calle">
                            </div>
                            <div class="form-group">
                                <label>Número <span class="required">*</span></label>
                                <input type="text" id="numero" required placeholder="Número exterior">
                            </div>
                            <div class="form-group">
                                <label>Colonia <span class="required">*</span></label>
                                <input type="text" id="colonia" required placeholder="Nombre de la colonia">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Entre Calles</label>
                                <input type="text" id="entreCalles" placeholder="Calle 1 y Calle 2">
                            </div>
                            <div class="form-group">
                                <label>Código Postal</label>
                                <input type="text" id="codigoPostal" placeholder="5 dígitos">
                            </div>
                        </div>

                        <button type="button" class="btn gps-button" onclick="getLocation(event)">
                            <i class="fas fa-map-marker-alt"></i> Usar mi Ubicación GPS
                        </button>

                        <div class="tip-box">
                            <strong>💡 Tip:</strong> El marcador se puede arrastrar para ajustar la ubicación exacta. Haz clic en el mapa para mover el marcador.
                        </div>

                        <div id="map"></div>
                        <p id="locationInfo" style="margin-top: 10px; color: #666;"></p>
                    </div>

                    <!-- Tipo de Servicio -->
                    <div class="form-section">
                        <h2>🛠️ Tipo de Servicio</h2>
                        <div class="form-group">
                            <label>Departamento <span class="required">*</span></label>
                            <select id="departamento" required>
                                <option value="">Seleccione el departamento</option>
                                <option value="alumbrado">💡 Alumbrado Público</option>
                                <option value="forestacion">🌳 Forestación</option>
                                <option value="limpieza">🧹 Ola Monclova (Barrido y Limpieza)</option>
                                <option value="bacheo">🛣️ Bacheo</option>
                                <option value="boteo">🚛 Boteo (Recolección)</option>
                                <option value="contenedores">🗑️ Contenedores (Recolección)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Descripción del Problema -->
                    <div class="form-section">
                        <h2>📝 Descripción del Problema</h2>
                        <div class="form-group">
                            <label>Describa el problema <span class="required">*</span></label>
                            <textarea id="descripcion" required minlength="20" placeholder="Describa detalladamente el problema (mínimo 20 caracteres)"></textarea>
                            <small style="color: #666;">Caracteres: <span id="charCount">0</span>/20 mínimo</small>
                        </div>
                    </div>

                    <!-- Evidencia Fotográfica -->
                    <div class="form-section">
                        <h2>📷 Evidencia Fotográfica</h2>
                        <div class="form-group">
                            <label>Foto del Problema (Opcional)</label>
                            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                                <div style="font-size: 48px; margin-bottom: 10px;">📸</div>
                                <p>Haga clic para tomar/seleccionar fotos</p>
                                <p style="font-size: 12px; color: #666; margin-top: 5px;">o arrastre las imágenes aquí (máximo 3 fotos)</p>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotos(event)">
                            <div class="photo-preview" id="photoPreview"></div>
                            <div class="tip-box" style="margin-top: 15px;">
                                <strong>💡</strong> Las fotografías ayudan a procesar más rápido el reporte
                            </div>
                        </div>
                    </div>

                    <!-- Información Adicional -->
                    <div class="form-section">
                        <h2>💬 Información Adicional</h2>
                        <div class="form-group">
                            <label>Comentarios adicionales</label>
                            <textarea id="comentarios" placeholder="Información extra que considere relevante"></textarea>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="submit-section">
                        <button type="button" class="btn btn-secondary" onclick="changeView(event, 'home')" style="margin-right: 10px;">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Enviar Reporte
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Reports View -->
        <div class="view-content" id="reportsView">
            <div class="content-card">
                <h2 style="color: #28a745; font-size: 28px; margin-bottom: 20px;">📋 Mis Reportes</h2>
                <div id="reportsList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        let map = null;
        let marker = null;
        let photos = [];
        let reports = [];
        let mapInitialized = false;

        function initMap() {
            if (mapInitialized && map) {
                map.invalidateSize();
                return;
            }

            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Contenedor del mapa no encontrado');
                return;
            }

            // Limpiar el contenedor si ya existe un mapa
            mapContainer.innerHTML = '';

            try {
                // Coordenadas de Monclova, Coahuila
                const monclovaLat = 26.9066;
                const monclovaLng = -101.4209;

                // Crear el mapa
                map = L.map('map').setView([monclovaLat, monclovaLng], 13);

                // Agregar capa de tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Crear marcador arrastrable
                marker = L.marker([monclovaLat, monclovaLng], {
                    draggable: true
                }).addTo(map);

                // Evento cuando se arrastra el marcador
                marker.on('dragend', function(e) {
                    const pos = marker.getLatLng();
                    updateLocationInfo(pos.lat, pos.lng);
                });

                // Evento click en el mapa para mover el marcador
                map.on('click', function(e) {
                    marker.setLatLng(e.latlng);
                    updateLocationInfo(e.latlng.lat, e.latlng.lng);
                });

                // Actualizar tamaño del mapa después de un breve delay
                setTimeout(() => {
                    map.invalidateSize();
                    updateLocationInfo(monclovaLat, monclovaLng);
                }, 100);

                mapInitialized = true;
                console.log('✅ Mapa inicializado correctamente');

            } catch (error) {
                console.error('❌ Error al inicializar el mapa:', error);
            }
        }

        function changeView(event, viewName) {
            event.preventDefault();

            // Ocultar todas las vistas
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => view.classList.remove('active'));

            // Mostrar la vista seleccionada
            const selectedView = document.getElementById(viewName + 'View');
            if (selectedView) {
                selectedView.classList.add('active');
            }

            // Actualizar navegación activa
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // Inicializar o actualizar el mapa cuando se muestra la vista de crear reporte
            if (viewName === 'create') {
                setTimeout(() => {
                    initMap();
                }, 100);
            }

            // Cargar reportes cuando se muestra la vista de reportes
            if (viewName === 'reports') {
                loadReports();
            }

            window.scrollTo(0, 0);
        }

        function getLocation(event) {
            event.preventDefault();
            event.stopPropagation();

            if (!navigator.geolocation) {
                alert('❌ Tu navegador no soporta geolocalización');
                return;
            }

            if (!map || !marker) {
                alert('⚠️ El mapa no está listo. Espera un momento.');
                return;
            }

            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicación...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Actualizar marcador y mapa
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 17);
                    updateLocationInfo(lat, lng);

                    // Feedback visual
                    btn.innerHTML = '<i class="fas fa-check-circle"></i> ¡Ubicación obtenida!';
                    btn.style.background = 'linear-gradient(135deg, #28a745 0%, #1e7e34 100%)';

                    alert('✅ Ubicación GPS obtenida correctamente\n\n' +
                          'Latitud: ' + lat.toFixed(6) + '\n' +
                          'Longitud: ' + lng.toFixed(6) + '\n' +
                          'Precisión: ±' + Math.round(accuracy) + ' metros');

                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-map-marker-alt"></i> Usar mi Ubicación GPS';
                        btn.disabled = false;
                        btn.style.background = '';
                    }, 3000);

                },
                function(error) {
                    let errorMsg = '';

                    switch(error.code) {
                        case 1:
                            errorMsg = '🔒 PERMISO DENEGADO\n\n' +
                                      '1. Busca el ícono 🔒 o ⓘ junto a la URL\n' +
                                      '2. Haz clic y permite "Ubicación"\n' +
                                      '3. Recarga la página (F5)';
                            break;
                        case 2:
                            errorMsg = '📡 SIN SEÑAL GPS\n\n' +
                                      '• Activa el GPS de tu dispositivo\n' +
                                      '• Sal al exterior si estás dentro\n' +
                                      '• Verifica tu conexión a internet';
                            break;
                        case 3:
                            errorMsg = '⏱️ TIEMPO AGOTADO\n\n' +
                                      '• Intenta nuevamente\n' +
                                      '• Sal al exterior\n' +
                                      '• Verifica tu conexión';
                            break;
                        default:
                            errorMsg = '❌ ERROR: ' + error.message;
                    }

                    alert(errorMsg);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        }

        function updateLocationInfo(lat, lng) {
            document.getElementById('locationInfo').textContent =
                `📍 Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        function handlePhotos(event) {
            const files = Array.from(event.target.files);

            if (photos.length + files.length > 3) {
                alert('⚠️ Máximo 3 fotos permitidas');
                return;
            }

            files.forEach(file => {
                if (photos.length < 3) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photos.push(e.target.result);
                        displayPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="photo-remove" onclick="removePhoto(${index})">×</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        function loadReports() {
            const reportData = {
                citizenReports: JSON.stringify(reports)
            };

            if (reportData.citizenReports && reportData.citizenReports !== '[]') {
                reports = JSON.parse(reportData.citizenReports);
            }
            displayReports();
        }

        function displayReports() {
            const container = document.getElementById('reportsList');

            if (reports.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 64px; color: #28a745; margin-bottom: 20px;"></i>
                        <p style="font-size: 18px;">No tienes reportes registrados</p>
                        <p>Crea tu primer reporte para comenzar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = reports.map((report, index) => `
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-folio">Folio: #${report.folio}</div>
                        <div class="report-status status-${report.status}">
                            ${report.status === 'pendiente' ? 'Pendiente' :
                              report.status === 'proceso' ? 'En Proceso' : 'Completado'}
                        </div>
                    </div>
                    <div class="report-info">
                        <div class="report-field">
                            <div class="report-field-label">Departamento</div>
                            <div class="report-field-value">${report.departamento}</div>
                        </div>
                        <div class="report-field">
                            <div class="report-field-label">Fecha</div>
                            <div class="report-field-value">${report.fecha}</div>
                        </div>
                        <div class="report-field">
                            <div class="report-field-label">Ubicación</div>
                            <div class="report-field-value">${report.calle} #${report.numero}, ${report.colonia}</div>
                        </div>
                    </div>
                    <div class="report-description">
                        <div class="report-description-label">Descripción del problema:</div>
                        <div class="report-description-text">${report.descripcion}</div>
                    </div>
                </div>
            `).join('');
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Contador de caracteres
            const descripcion = document.getElementById('descripcion');
            if (descripcion) {
                descripcion.addEventListener('input', function() {
                    document.getElementById('charCount').textContent = this.value.length;
                });
            }

            // Manejo del formulario
            const form = document.getElementById('reportForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const departamentos = {
                        'alumbrado': 'Alumbrado Público',
                        'forestacion': 'Forestación',
                        'limpieza': 'Ola Monclova',
                        'bacheo': 'Bacheo',
                        'boteo': 'Boteo',
                        'contenedores': 'Contenedores'
                    };

                    const folio = Math.floor(Math.random() * 90000) + 10000;
                    const position = marker.getLatLng();

                    const newReport = {
                        folio: folio,
                        nombre: document.getElementById('nombre').value,
                        telefono: document.getElementById('telefono').value,
                        calle: document.getElementById('calle').value,
                        numero: document.getElementById('numero').value,
                        colonia: document.getElementById('colonia').value,
                        entreCalles: document.getElementById('entreCalles').value,
                        codigoPostal: document.getElementById('codigoPostal').value,
                        departamento: departamentos[document.getElementById('departamento').value],
                        descripcion: document.getElementById('descripcion').value,
                        comentarios: document.getElementById('comentarios').value,
                        coordenadas: {
                            lat: position.lat,
                            lng: position.lng
                        },
                        fotos: photos,
                        fecha: new Date().toLocaleDateString('es-MX'),
                        status: 'pendiente'
                    };

                    reports.unshift(newReport);

                    alert('✅ Reporte enviado exitosamente!\n\nNúmero de folio: #' + folio + '\n\nPuedes consultar el estado de tu reporte en la sección "Mis Reportes"');

                    // Limpiar formulario
                    form.reset();
                    photos = [];
                    displayPhotos();
                    document.getElementById('charCount').textContent = '0';

                    // Reiniciar mapa a coordenadas de Monclova
                    if (marker) {
                        marker.setLatLng([26.9066, -101.4209]);
                        map.setView([26.9066, -101.4209], 13);
                        updateLocationInfo(26.9066, -101.4209);
                    }

                    // Volver a la vista de inicio
                    const homeLink = document.querySelector('.nav-item');
                    changeView({target: homeLink, preventDefault: () => {}}, 'home');
                });
            }

            // Cargar reportes al iniciar
            loadReports();
        });
    </script>
</body>
</html>
