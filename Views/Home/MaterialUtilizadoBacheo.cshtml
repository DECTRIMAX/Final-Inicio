<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Utilizado - Monclova</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #DC2626;
            --primary-light: #F87171;
            --secondary: #B91C1C;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            --bg-primary: #0F0F0F;
            --bg-secondary: #1A1A1A;
            --bg-tertiary: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #B3B3B3;
            --border: #333333;
            --card-bg: #1F1F1F;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #111111 0%, #2A2A2A 100%);
            padding: 1.2rem 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid var(--border);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1600px;
            margin: 0 auto;
            gap: 1.5rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .logo-container {
            display: flex;
            gap: 0.8rem;
        }

        .logo {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--primary);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            overflow: hidden;
            padding: 5px;
        }

            .logo i {
                color: var(--primary);
                font-size: 1.4rem;
            }

            .logo img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

        .header-info h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
        }

        .header-info p {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--primary);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
            overflow: hidden;
        }

            .user-avatar i {
                color: var(--primary);
                font-size: 1.3rem;
            }

            .user-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .nav-toggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 50% 0 0 50%;
            color: white;
            font-size: 1.15rem;
            cursor: pointer;
            box-shadow: -4px 0 20px rgba(220, 38, 38, 0.5);
            z-index: 1500;
            transition: all 0.3s ease;
        }

            .nav-toggle:hover {
                width: 56px;
            }

        .nav-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: var(--card-bg);
            border-left: 2px solid var(--border);
            box-shadow: -8px 0 40px rgba(0, 0, 0, 0.8);
            z-index: 1400;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem 1rem;
        }

            .nav-panel.open {
                right: 0;
            }

        .nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1399;
            display: none;
        }

            .nav-overlay.show {
                display: block;
            }

        .nav-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .nav-logo {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }

        .nav-header h3 {
            font-size: 1.15rem;
            color: var(--primary);
            font-weight: 800;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.95rem;
            margin: 0.5rem 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .nav-item:hover {
                background: var(--bg-tertiary);
                border-color: var(--primary);
                transform: translateX(-5px);
            }

            .nav-item.active {
                background: var(--primary);
                border-color: var(--primary);
            }

            .nav-item i {
                font-size: 1.25rem;
                color: var(--primary);
                width: 30px;
                text-align: center;
            }

            .nav-item.active i,
            .nav-item.active span {
                color: white;
            }

            .nav-item span {
                font-weight: 600;
                color: var(--text-secondary);
                font-size: 0.92rem;
            }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.9rem;
            margin-bottom: 1.2rem;
        }

        .stat-item {
            background: var(--card-bg);
            padding: 1.1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.3s ease;
        }

            .stat-item:hover {
                border-color: var(--primary);
                transform: translateY(-3px);
            }

        .stat-number {
            font-size: 1.9rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.35rem;
        }

        .stat-label {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .toolbar {
            background: var(--card-bg);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.2rem;
            border: 1px solid var(--border);
        }

        .toolbar-row {
            display: flex;
            gap: 0.85rem;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 0.85rem;
        }

            .toolbar-row:last-child {
                margin-bottom: 0;
            }

        .search-box {
            flex: 1;
            min-width: 230px;
            position: relative;
        }

            .search-box input {
                width: 100%;
                padding: 0.75rem 1rem 0.75rem 2.4rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 10px;
                color: var(--text-primary);
                font-size: 0.88rem;
            }

            .search-box i {
                position: absolute;
                left: 0.85rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-secondary);
            }

        .filter-group {
            display: flex;
            gap: 0.65rem;
            flex-wrap: wrap;
            flex: 1;
        }

        select {
            padding: 0.75rem 0.95rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.82rem;
            cursor: pointer;
            min-width: 125px;
            flex: 1;
        }

        .btn {
            padding: 0.75rem 1.35rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.88rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
            }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

            .btn-secondary:hover {
                border-color: var(--primary);
                color: var(--text-primary);
            }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 62px;
            height: 62px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            font-size: 1.65rem;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(220, 38, 38, 0.5);
            z-index: 999;
            transition: all 0.3s ease;
        }

            .fab:hover {
                transform: scale(1.12) rotate(90deg);
                box-shadow: 0 12px 40px rgba(220, 38, 38, 0.7);
            }

        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .record-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.35rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

            .record-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 12px 40px rgba(220, 38, 38, 0.2);
                border-color: var(--primary);
            }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .record-type {
            padding: 0.38rem 0.75rem;
            border-radius: 8px;
            font-size: 0.72rem;
            font-weight: 700;
        }

        .type-fria {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .type-caliente {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .record-folio {
            background: var(--bg-tertiary);
            padding: 0.38rem 0.75rem;
            border-radius: 8px;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .record-details {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            margin-top: 0.85rem;
            padding-top: 0.85rem;
            border-top: 1px solid var(--border);
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.87rem;
            color: var(--text-secondary);
        }

            .detail-item i {
                width: 17px;
                color: var(--primary);
            }

        .record-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.85rem;
            padding-top: 0.85rem;
            border-top: 1px solid var(--border);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: var(--card-bg);
            border-radius: 17px;
            padding: 1.9rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.6rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.15rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.45rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.87rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.92rem;
            font-family: inherit;
        }

            .form-input:focus, .form-select:focus, .form-textarea:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(185px, 1fr));
            gap: 0.95rem;
        }

        .calculated-field {
            background: rgba(220, 38, 38, 0.12) !important;
            border-color: var(--primary) !important;
            font-weight: 700;
            color: var(--primary) !important;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3.5rem 2rem;
            color: var(--text-secondary);
        }

            .empty-state i {
                font-size: 3.8rem;
                margin-bottom: 0.9rem;
                color: var(--border);
            }

        .notification {
            position: fixed;
            top: 1.6rem;
            right: 1.6rem;
            padding: 0.95rem 1.4rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            z-index: 3000;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.92rem;
        }

            .notification.show {
                display: flex;
            }

            .notification.success {
                background: var(--success);
                color: white;
            }

            .notification.error {
                background: var(--danger);
                color: white;
            }

            .notification.info {
                background: var(--info);
                color: white;
            }

        .sync-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-container">
                    <div class="logo">
                        <img src="~/imagenes/bacheo.png" alt="Bacheo" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-road\' style=\'color: var(--primary); font-size: 1.4rem;\'></i>'">
                    </div>
                    <div class="logo">
                        <img src="~/imagenes/LOGO.png" alt="Gobierno" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-landmark\' style=\'color: var(--primary); font-size: 1.4rem;\'></i>'">
                    </div>
                </div>
                <div class="header-info">
                    <h1>Material Utilizado</h1>
                    <p>Municipio de Monclova, Coahuila</p>
                </div>
            </div>
            <div class="user-avatar">
                <img src="~/imagenes/angel.jpeg" alt="Usuario" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-user-cog\' style=\'color: var(--primary); font-size: 1.3rem;\'></i>'">
            </div>
        </div>
    </header>

    <div class="nav-overlay" id="navOverlay"></div>

    <button class="nav-toggle" id="navToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="nav-panel" id="navPanel">
        <div class="nav-header">
            <div class="nav-logo">
                <i class="fas fa-road" style="color: var(--primary);"></i>
            </div>
            <h3>Navegación</h3>
        </div>
        <div class="nav-item" onclick="navigateTo('captura')">
            <i class="fas fa-edit"></i>
            <span>Captura</span>
        </div>
        <div class="nav-item" onclick="navigateTo('mapa')">
            <i class="fas fa-map-marked-alt"></i>
            <span>Mapa</span>
        </div>
        <div class="nav-item" onclick="navigateTo('rastreo')">
            <i class="fas fa-search-location"></i>
            <span>Rastreo</span>
        </div>
        <div class="nav-item" onclick="navigateTo('dashboard')">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="navigateTo('reportes')">
            <i class="fas fa-file-alt"></i>
            <span>Reportes</span>
        </div>
        <div class="nav-item active" onclick="navigateTo('material')">
            <i class="fas fa-boxes"></i>
            <span>Material</span>
        </div>
        <div class="nav-item" onclick="navigateTo('asistencia')">
            <i class="fas fa-users"></i>
            <span>Asistencia</span>
        </div>
        <div class="nav-item" onclick="navigateTo('programacion')">
            <i class="fas fa-calendar-alt"></i>
            <span>Programación</span>
        </div>
    </div>

    <div class="container">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalRecords">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalFria">0</div>
                <div class="stat-label">Carpeta Fría (ton)</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalCaliente">0</div>
                <div class="stat-label">Carpeta Caliente (ton)</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="monthRecords">0</div>
                <div class="stat-label">Mes Actual</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalMaterial">0</div>
                <div class="stat-label">Total Material (ton)</div>
            </div>
        </div>

        <div class="toolbar">
            <div class="toolbar-row">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar por folio, camión, sector...">
                </div>
                <button class="btn btn-warning" id="syncBtn">
                    <i class="fas fa-sync-alt"></i>
                    Sincronizar
                </button>
                <button class="btn btn-primary" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
            </div>
            <div class="toolbar-row">
                <div class="filter-group">
                    <select id="filterType">
                        <option value="all">Todos</option>
                        <option value="FRIA">Carpeta Fría</option>
                        <option value="CALIENTE">Carpeta Caliente</option>
                    </select>
                    <select id="filterMonth">
                        <option value="">Meses</option>
                    </select>
                    <select id="filterTruck">
                        <option value="">Camiones</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="recordsContainer" class="records-grid"></div>
    </div>

    <button class="fab" id="addBtn">
        <i class="fas fa-plus"></i>
    </button>

    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nuevo Registro de Material</h2>
                <button class="btn btn-secondary" onclick="closeFormModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="recordForm">
                <input type="hidden" id="editingId">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo de Carpeta Asfáltica</label>
                        <select class="form-select" id="materialType" required>
                            <option value="">Seleccionar...</option>
                            <option value="FRIA">Carpeta Fría</option>
                            <option value="CALIENTE">Carpeta Caliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="date" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Sector</label>
                        <input type="text" class="form-input" id="sector" required placeholder="Ej: 311">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Camión</label>
                        <input type="text" class="form-input" id="truck" required placeholder="Ej: 19">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Cantidad (Toneladas)</label>
                    <input type="number" step="0.01" class="form-input" id="quantity" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label class="form-label">Folio de Referencia (Opcional)</label>
                    <input type="text" class="form-input" id="referenceFolio" placeholder="Folio del trabajo de captura">
                </div>

                <div class="form-group">
                    <label class="form-label">Observaciones (Opcional)</label>
                    <textarea class="form-textarea" id="observations" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:1rem;">
                    <i class="fas fa-save"></i>
                    Guardar Registro
                </button>
            </form>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText"></span>
    </div>

    <script>
        let records = [];
        let folioCounter = 1;

        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            syncFromCaptura();
            setupEventListeners();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            updateStats();
            populateFilters();
        });

        function setupEventListeners() {
            document.getElementById('navToggle').addEventListener('click', toggleNav);
            document.getElementById('navOverlay').addEventListener('click', closeNav);
            document.getElementById('addBtn').addEventListener('click', openFormModal);
            document.getElementById('recordForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('searchInput').addEventListener('input', renderRecords);
            document.getElementById('filterType').addEventListener('change', renderRecords);
            document.getElementById('filterMonth').addEventListener('change', renderRecords);
            document.getElementById('filterTruck').addEventListener('change', renderRecords);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('syncBtn').addEventListener('click', syncFromCaptura);
        }

        function navigateTo(section) {
            const routes = {
                'captura': '/Home/CapturaBacheo',
                'mapa': '/Home/MapaBacheo',
                'rastreo': '/Home/RastreoBacheo',
                'dashboard': '/Home/DashboardBacheo',
                'reportes': '/Home/ReportesBacheo',
                'material': '/Home/MaterialUtilizadoBacheo',
                'asistencia': '/Home/AsistenciaPersonalBacheo',
                'programacion': '/Home/ProgramacionBacheo'
            };

            const route = routes[section];
            if (route) {
                showNotification('Navegando a ' + section, 'info');
                closeNav();
                setTimeout(function() {
                    window.location.href = route;
                }, 500);
            }
        }

        function toggleNav() {
            document.getElementById('navPanel').classList.toggle('open');
            document.getElementById('navOverlay').classList.toggle('show');
        }

        function closeNav() {
            document.getElementById('navPanel').classList.remove('open');
            document.getElementById('navOverlay').classList.remove('show');
        }

        function syncFromCaptura() {
            const capturaRecords = JSON.parse(localStorage.getItem('serviciosPrimariosRecords') || '[]');
            let newRecordsCount = 0;

            capturaRecords.forEach(function(capturaRecord) {
                const exists = records.some(function(r) {
                    return r.referenceFolio === capturaRecord.folio;
                });

                if (!exists && (capturaRecord.type === 'BACHEO' || capturaRecord.type === 'BORDO')) {
                    const area = parseFloat(capturaRecord.area) || 0;
                    let quantity = 0;
                    let materialType = 'FRIA';

                    if (capturaRecord.type === 'BACHEO') {
                        quantity = (area * 0.05).toFixed(2);
                        materialType = 'FRIA';
                    } else if (capturaRecord.type === 'BORDO') {
                        const thickness = parseFloat(capturaRecord.thickness) || 5;
                        quantity = (area * thickness * 0.01).toFixed(2);
                        materialType = 'CALIENTE';
                    }

                    if (quantity > 0) {
                        const materialRecord = {
                            id: Date.now() + newRecordsCount,
                            folio: generateFolio(),
                            type: materialType,
                            date: capturaRecord.date,
                            sector: capturaRecord.sector,
                            truck: capturaRecord.truck,
                            quantity: quantity,
                            referenceFolio: capturaRecord.folio,
                            observations: 'Sincronizado desde captura',
                            syncedFrom: 'captura'
                        };
                        records.push(materialRecord);
                        newRecordsCount++;
                    }
                }
            });

            if (newRecordsCount > 0) {
                saveRecords();
                showNotification('Sincronizados ' + newRecordsCount + ' registros nuevos', 'success');
                renderRecords();
                updateStats();
                populateFilters();
            } else {
                showNotification('No hay registros nuevos para sincronizar', 'info');
            }
        }

        function openFormModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Registro de Material';
            document.getElementById('editingId').value = '';
            document.getElementById('recordForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('formModal').classList.add('active');
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
            document.getElementById('recordForm').reset();
            document.getElementById('editingId').value = '';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function generateFolio() {
            const date = new Date();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear().toString().slice(-2);
            const num = String(folioCounter).padStart(4, '0');
            folioCounter++;
            return 'MAT' + month + year + '-' + num;
        }

        function handleFormSubmit(e) {
            e.preventDefault();

            const editingId = document.getElementById('editingId').value;

            if (editingId) {
                const index = records.findIndex(function(r) { return r.id == editingId; });
                if (index !== -1) {
                    records[index] = {
                        id: parseInt(editingId),
                        folio: records[index].folio,
                        type: document.getElementById('materialType').value,
                        date: document.getElementById('date').value,
                        sector: document.getElementById('sector').value,
                        truck: document.getElementById('truck').value,
                        quantity: document.getElementById('quantity').value,
                        referenceFolio: document.getElementById('referenceFolio').value,
                        observations: document.getElementById('observations').value
                    };
                    showNotification('Registro actualizado correctamente', 'success');
                }
            } else {
                const record = {
                    id: Date.now(),
                    folio: generateFolio(),
                    type: document.getElementById('materialType').value,
                    date: document.getElementById('date').value,
                    sector: document.getElementById('sector').value,
                    truck: document.getElementById('truck').value,
                    quantity: document.getElementById('quantity').value,
                    referenceFolio: document.getElementById('referenceFolio').value,
                    observations: document.getElementById('observations').value
                };
                records.push(record);
                showNotification('Registro guardado correctamente', 'success');
            }

            saveRecords();
            closeFormModal();
            renderRecords();
            updateStats();
            populateFilters();
        }

        function loadRecords() {
            const saved = localStorage.getItem('materialUtilizadoRecords');
            if (saved) {
                records = JSON.parse(saved);
                folioCounter = parseInt(localStorage.getItem('materialFolioCounter') || '1');
            }
            renderRecords();
        }

        function saveRecords() {
            localStorage.setItem('materialUtilizadoRecords', JSON.stringify(records));
            localStorage.setItem('materialFolioCounter', folioCounter.toString());
        }

        function renderRecords() {
            const container = document.getElementById('recordsContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const monthFilter = document.getElementById('filterMonth').value;
            const truckFilter = document.getElementById('filterTruck').value;

            let filtered = records.filter(function(r) {
                const matchSearch = !search ||
                    r.folio.toLowerCase().indexOf(search) > -1 ||
                    r.sector.toLowerCase().indexOf(search) > -1 ||
                    r.truck.toLowerCase().indexOf(search) > -1 ||
                    (r.referenceFolio && r.referenceFolio.toLowerCase().indexOf(search) > -1);
                const matchType = typeFilter === 'all' || r.type === typeFilter;
                const matchMonth = !monthFilter || r.date.indexOf(monthFilter) === 0;
                const matchTruck = !truckFilter || r.truck === truckFilter;
                return matchSearch && matchType && matchMonth && matchTruck;
            });

            filtered.sort(function(a, b) {
                return new Date(b.date) - new Date(a.date);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<i class="fas fa-boxes"></i>' +
                    '<h3>No hay registros</h3>' +
                    '<p>Agrega tu primer registro de material o sincroniza desde captura</p>' +
                    '</div>';
                return;
            }

            container.innerHTML = filtered.map(function(r) {
                const syncBadge = r.syncedFrom ? '<span class="sync-badge"><i class="fas fa-sync-alt"></i> Auto</span>' : '';

                return '<div class="record-card">' +
                    '<div class="record-header">' +
                    '<div style="display:flex; gap:0.5rem; align-items:center;">' +
                    '<span class="record-type type-' + r.type.toLowerCase() + '">' +
                    (r.type === 'FRIA' ? 'Carpeta Fría' : 'Carpeta Caliente') + '</span>' +
                    syncBadge +
                    '</div>' +
                    '<span class="record-folio">' + r.folio + '</span>' +
                    '</div>' +
                    '<h3 style="font-size:1.08rem; margin-bottom:0.45rem; color:var(--text-primary);">Sector ' + r.sector + '</h3>' +
                    '<p style="color:var(--text-secondary); font-size:0.82rem;">' +
                    '<i class="fas fa-calendar"></i> ' + formatDate(r.date) +
                    '</p>' +
                    '<div class="record-details">' +
                    '<div class="detail-item"><i class="fas fa-truck"></i><span>Camión: ' + r.truck + '</span></div>' +
                    '<div class="detail-item"><i class="fas fa-weight-hanging"></i><span>Cantidad: ' + r.quantity + ' toneladas</span></div>' +
                    (r.referenceFolio ? '<div class="detail-item"><i class="fas fa-link"></i><span>Ref: ' + r.referenceFolio + '</span></div>' : '') +
                    (r.observations ? '<div class="detail-item"><i class="fas fa-comment"></i><span>' + r.observations + '</span></div>' : '') +
                    '</div>' +
                    '<div class="record-actions">' +
                    '<button class="btn btn-secondary" onclick="editRecord(' + r.id + ')" style="flex:1;"><i class="fas fa-edit"></i> Editar</button>' +
                    '<button class="btn btn-danger" onclick="deleteRecord(' + r.id + ')" style="flex:1;"><i class="fas fa-trash"></i> Eliminar</button>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        function deleteRecord(id) {
            if (!confirm('¿Eliminar este registro?')) return;
            records = records.filter(function(r) { return r.id !== id; });
            saveRecords();
            showNotification('Registro eliminado', 'success');
            renderRecords();
            updateStats();
            populateFilters();
        }

        function editRecord(id) {
            const record = records.find(function(r) { return r.id === id; });
            if (!record) return;

            document.getElementById('modalTitle').textContent = 'Editar Registro de Material';
            document.getElementById('editingId').value = record.id;
            document.getElementById('materialType').value = record.type;
            document.getElementById('date').value = record.date;
            document.getElementById('sector').value = record.sector;
            document.getElementById('truck').value = record.truck;
            document.getElementById('quantity').value = record.quantity;
            document.getElementById('referenceFolio').value = record.referenceFolio || '';
            document.getElementById('observations').value = record.observations || '';

            document.getElementById('formModal').classList.add('active');
            showNotification('Editando registro', 'info');
        }

        function updateStats() {
            document.getElementById('totalRecords').textContent = records.length;

            const totalFria = records.filter(function(r) { return r.type === 'FRIA'; })
                .reduce(function(sum, r) { return sum + parseFloat(r.quantity); }, 0);
            document.getElementById('totalFria').textContent = totalFria.toFixed(2);

            const totalCaliente = records.filter(function(r) { return r.type === 'CALIENTE'; })
                .reduce(function(sum, r) { return sum + parseFloat(r.quantity); }, 0);
            document.getElementById('totalCaliente').textContent = totalCaliente.toFixed(2);

            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthRecords = records.filter(function(r) {
                return r.date.indexOf(currentMonth) === 0;
            }).length;
            document.getElementById('monthRecords').textContent = monthRecords;

            const totalMaterial = totalFria + totalCaliente;
            document.getElementById('totalMaterial').textContent = totalMaterial.toFixed(2);
        }

        function populateFilters() {
            const monthSelect = document.getElementById('filterMonth');
            const truckSelect = document.getElementById('filterTruck');

            const trucks = records.map(function(r) { return r.truck; })
                .filter(function(v, i, a) { return a.indexOf(v) === i; }).sort();
            truckSelect.innerHTML = '<option value="">Camiones</option>' +
                trucks.map(function(t) { return '<option value="' + t + '">Camión ' + t + '</option>'; }).join('');

            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const year = new Date().getFullYear();
            monthSelect.innerHTML = '<option value="">Meses</option>' +
                months.map(function(m, i) {
                    const monthValue = year + '-' + String(i + 1).padStart(2, '0');
                    return '<option value="' + monthValue + '">' + m + ' ' + year + '</option>';
                }).join('');
        }

        function formatDate(dateStr) {
            const parts = dateStr.split('-');
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return day + '-' + months[parseInt(month) - 1] + '-' + year;
        }

        function exportToCSV() {
            if (records.length === 0) {
                showNotification('No hay registros para exportar', 'error');
                return;
            }

            let csv = '\uFEFFFOLIO,TIPO,FECHA,SECTOR,CAMIÓN,CANTIDAD (TON),REFERENCIA,OBSERVACIONES\n';

            records.forEach(function(r) {
                const typeName = r.type === 'FRIA' ? 'Carpeta Fría' : 'Carpeta Caliente';
                csv += '"' + r.folio + '","' + typeName + '","' + r.date + '","' + r.sector + '","' + r.truck + '","' + r.quantity + '","' + (r.referenceFolio || '') + '","' + (r.observations || '') + '"\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'MATERIAL_UTILIZADO_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('Exportados ' + records.length + ' registros', 'success');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            const icon = notification.querySelector('i');

            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-info-circle';
            }

            notification.className = 'notification ' + type + ' show';
            text.textContent = message;

            setTimeout(function() {
                notification.classList.remove('show');
            }, 3000);
        }

        console.log('Sistema de Material Utilizado - Iniciado correctamente');
        console.log('Sincronización automática desde Captura activada');
    </script>
</body>
</html>